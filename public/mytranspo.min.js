var Map={latitude:45.423415,longitude:-75.698379,map:" ",markersArray:[],Boundaries:{swLat:0,swLng:0,neLat:0,neLng:0},init:function(a){if(navigator.geolocation){Map.latitude=a.coords.latitude;Map.longitude=a.coords.longitude}},createmap:function(){latlng=new google.maps.LatLng(this.latitude,this.longitude);var a={zoom:17,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:true,navigationControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.ANDROID},mapTypeControl:false};Map.map=new google.maps.Map(document.getElementById("map_canvas"),a);google.maps.event.addListener(Map.map,"tilesloaded",function(){Map.redoBoundaries();Map.addpoints();google.maps.event.clearListeners(Map.map,"tilesloaded")});google.maps.event.addListener(Map.map,"dragend",function(){if(Map.map.zoom<16){return}Map.redoBoundaries();Map.addpoints()});google.maps.event.addListener(Map.map,"zoom_changed",function(){if(Map.map.zoom<16){alert("Stops not available at this zoom level. Please zoom in to load more stops.");return}setTimeout(function(){Map.redoBoundaries();Map.addpoints()},100)})},addpoints:function(){$.get("/points/"+Map.Boundaries.swLat+"/"+Map.Boundaries.neLat+"/"+Map.Boundaries.swLng+"/"+Map.Boundaries.neLng,function(response){var result=eval(response);for(var key in result){var stopLatLng=new google.maps.LatLng(result[key]["stop"]["stop_lat"]-0.00001,result[key]["stop"]["stop_lon"]+0.0000455);var marker=new google.maps.Marker({position:stopLatLng,map:Map.map,title:result[key]["stop"]["stop_name"],icon:"bus.png"});var id=result[key]["stop"]["stop_id"];google.maps.event.addListener(marker,"click",Map.handleMarkerClick(id));Map.markersArray.unshift(marker);if(Map.markersArray.length>50){var deleteme=Map.markersArray.pop();deleteme.setMap(null)}}})},changeBoundaries:function(b,d,c,a){this.minLat=b;this.maxLat=d;this.minLon=c;this.maxLon=a},redoBoundaries:function(){this.Boundaries.swLat=Map.map.getBounds().getSouthWest().lat();this.Boundaries.swLng=Map.map.getBounds().getSouthWest().lng();this.Boundaries.neLat=Map.map.getBounds().getNorthEast().lat();this.Boundaries.neLng=Map.map.getBounds().getNorthEast().lng()},printBoundaries:function(){$("#map_canvas").html("SWLon: "+this.Boundaries.swLng+"<br />SWLat: "+this.Boundaries.swLat+"<br />NELon: "+this.Boundaries.neLng+"<br />NELat: "+this.Boundaries.neLat+"<br />")},handleMarkerClick:function(stop_id){return function(){$.get("/stopinfo/"+stop_id,function(response){var nextbuses=eval(response);$("#buses").html("<tr><th colspan=1>Route</th><th>Destination</th><th colspan=1>Time</th></tr>");for(var key in nextbuses){var depTime=nextbuses[key]["departure_time"].replace(/:00$/,"");if(depTime.match(/^0[1-9]/)||depTime.match(/^1[0-1]/)){depTime+="AM"}else{if(depTime.match(/^12/)){depTime+="PM"}else{if(depTime.match(/^00/)){var newTime=depTime.split(/:/);depTime="12:"+newTime[1]+"AM"}else{if(depTime.match(/^1[3-9]/)){var newTime=depTime.split(/:/);newTime[0]-=12;depTime=newTime[0]+":"+newTime[1]+"PM"}else{var newTime=depTime.split(/:/);newTime[0]-=12;depTime=newTime[0]+":"+newTime[1]+"PM"}}}}$("#buses").append("<tr><td>"+nextbuses[key]["route_short_name"]+"</td><td>"+nextbuses[key]["trip_headsign"]+"</td><td>"+depTime+"</td></tr>")}$("#map_holder").addClass("hidden");$("#map_holder").css({height:0});$("#stop_times").removeClass("hidden");$("#stop_times").css({height:$("body").height()-45});$("#buses").css({marginLeft:($("#bus_info").width()-$("#buses").width())/2})})}},setLatLng:function(b,a){this.latitude=b;this.longitude=a}};